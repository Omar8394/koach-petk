{% extends "layouts/base.html" %}
{% load i18n %}
{% block title %}{% endblock %} 

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}

{% endblock stylesheets %}

{% block content %}

	<div class="content">
		<div class="page-inner">
			<div class="page-header">
				<h4 class="page-title">Starter page</h4>
				<ul class="breadcrumbs">
					<li class="nav-home">
						<a href="{% url 'Dashboard' %}">
							<i class="flaticon-home"></i>
						</a>
					</li>
					<li class="separator">
						<i class="flaticon-right-arrow"></i>
					</li>
					<li class="nav-item">
						<span>Module name</span>
					</li>
					<li class="separator">
						<i class="flaticon-right-arrow"></i>
					</li>
					<li class="nav-item">
						<a href="#">Page 1</a>
					</li>
				</ul>
			</div>
			<div class="page-category">
				<div class="form-group" id="groupDate">

					<div class="row">
						<div class="card col-12" style="background-color: #1a2035 !important; color: white;">
							<div class="section-header">
								<h3 >Nueva actividad</h3> 
                              <div onclick="openAddActivity('{{id}}')" class="btn btn-icon btn-success btn-round add-btn btn-card-lg">
                             <i class="fas fa-plus"></i>
                              </div>
								
							 </div> 
							<div class="card-body m-0 p-0" >
								<ul id="resultado">
                              
								</ul>
							   
					       </div>
					    </div>
	
						
					</div>
	
				</div>
      		</div>
		</div>
	</div>
	<div class="modal fade" id="addChooseActivities" tabindex="-1" role="dialog">
		<div class="modal-dialog  modal-dialog-centered" role="document" id="modalContentChoose">
	 
		</div>
	 </div>
	 <div class="modal fade" id="addNewModal" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-lg modal-dialog-centered" role="document" id="addNewModalContent">
	 
		</div>
	 </div>
{% endblock content %}
	
<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
	let ids={{id}}
    let query = ""
	
	let editmode = false
	const renderContent = (id)=>{
		document.querySelector("#resultado").classList.add("is-loading")
		fetch("{% url 'renderactividades'%}", {
		   ...fetchObject,
		   body: JSON.stringify({
			  query,
			  id
		   })
		})
		.then(async(res)=>{
		   result = await res.text()
		   document.querySelector("#resultado").classList.remove("is-loading")
		   document.querySelector("#resultado").innerHTML = result
		})
	 }
	 renderContent(ids)
	 const openAddActivity = (idPadre) => {
		editmode = false
		selectedActivity = idPadre
		renderModalChooseActivities(selectedActivity).then(() => {
		   $("#addChooseActivities").modal("show")
		})
	 }
  
	 const renderModalChooseActivities = (id) => {
		return fetch("{% url 'modalChooseActivity' %}", {
		   ...fetchObject,
		   body: JSON.stringify({
			  method: "Show",
			  id
		   })
		})
		   .then(async (res) => {
			  document.getElementById("modalContentChoose").innerHTML = await res.text()
		   })
	 }	
	 const chooseModal = async (type,id) => {
		
		
		let url
		
		if (type == "lesson") {
		   url = "{% url 'modalNewLesson' %}"
		}
		await renderModalActivity(url,id)
		$("#addChooseActivities").modal("hide")
	 } 
	 const renderModalActivity = (url,id) => {
		idSeleted=id
		editmode = false
		return fetch(url, {
		   ...fetchObject,
		   body: JSON.stringify({
			  method: "Show",
			  id
		   })
		})
		   .then(async (res) => {
			  document.getElementById("addNewModalContent").innerHTML = await res.text()
		   })
		   .then(() => {
			  $("#addNewModal").modal("show")
			  const formPrograma = document.getElementById("formActividad")
			  let rules = {
				descriptionActivity: {
					required: true,
					maxlength: 200,
					minlength: 3
				 },
				 urlActivity: {
					required: true,
					maxlength: 200,
					minlength: 3
				 },
				 resumenActivity: {
					required: true,
					maxlength: 200,
					minlength: 3
				 },
				 disponibleLesson: {
					required: true
					
				 },
				 estatusLesson: {
					required: true
					
				 },
				 creditos: {
					required: true
					
				 },
				 Componente: {
					required: true
					
				 },
			  }
			  commonValidator = $("#formActividad").validate({
				rules,
				highlight: function (element) {
				   $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
				},
				success: function (element) {
				   $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
				},
			 });
			 formPrograma.addEventListener("submit", (e) => {
				e.preventDefault()
				if($("#formActividad").valid()){
				   setLoading()
				   clickSave(formPrograma, "{% url 'modalNewLesson' %}")
					  .then(() => {
						 $("#addNewModal").modal("hide")
						 renderContent(idSeleted)
						 stopLoading()
						 
					  })
	
				}
			 })
		   })
	 }
	 const EditActivity = (id,padre) => {
		let idp=padre
		idSeleted=id
		
		editmode = true
		return fetch("{% url 'modalNewLesson' %}", {
		   ...fetchObject,
		   body: JSON.stringify({
			  method: "Edit",
			  id
		   })
		})
		   .then(async (res) => {
			  document.getElementById("addNewModalContent").innerHTML = await res.text()
		   })
		   .then(() => {
			  $("#addNewModal").modal("show")
			  const formPrograma = document.getElementById("formActividad")
			  let rules = {
				descriptionActivity: {
					required: true,
					maxlength: 200,
					minlength: 3
				 },
				 urlActivity: {
					required: true,
					maxlength: 200,
					minlength: 3
				 },
				 resumenActivity: {
					required: true,
					maxlength: 200,
					minlength: 3
				 },
				 disponibleLesson: {
					required: true
					
				 },
				 estatusLesson: {
					required: true
					
				 },
				 creditos: {
					required: true
					
				 },
				 Componente: {
					required: true
					
				 },
			  }
			  commonValidator = $("#formActividad").validate({
				rules,
				highlight: function (element) {
				   $(element).closest('.form-group').removeClass('has-success').addClass('has-error');
				},
				success: function (element) {
				   $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
				},
			 });
			 formPrograma.addEventListener("submit", (e) => {
				e.preventDefault()
				if($("#formActividad").valid()){
				   setLoading()
				   clickSave(formPrograma, "{% url 'modalNewLesson' %}")
					  .then(() => {
						 $("#addNewModal").modal("hide")
						 renderContent(idp)
						 stopLoading()
						 
					  })
	
				}
			 })
		   })
	 }
	 const updateModel = (url, method, data, id) => {
        return fetch(url, {
           ...fetchObject,
           body: JSON.stringify({
              method,
              data,
              id
           })
        })
     }
	 const clickSave = (formElement, url) => {
        const formData = new FormData(formElement);
        const data = {}
     
        for (var [key, value] of formData.entries()) {
           data[key] = value
        }
        if (editmode) {
           return updateModel(url, "Update", data, idSeleted)
              .then(async (res) => {
                 const text = JSON.parse(await res.text())
                 if (text.message == "error")  makeMessage(4, "{% translate 'Error' %}", "{% translate 'Ha ocurrido un error y no se pudo procesar su solicitud' %}", 'fa fa-exclamation-triangle')

                 else  makeMessage(1, "{% translate 'Muy Bien!' %}", "{% translate 'Registro guardado' %}", "fa fa-check")

              })
        }
        else {
           return updateModel(url, "Create", data, idSeleted)
              .then(async (res) => {
                 const text = JSON.parse(await res.text())
                 if (text.message == "error")  makeMessage(4, "{% translate 'Error' %}", "{% translate 'Ha ocurrido un error y no se pudo procesar su solicitud' %}", 'fa fa-exclamation-triangle')

                 else  makeMessage(1, "{% translate 'Muy Bien!' %}", "{% translate 'Registro guardado' %}", "fa fa-check")

              })
        }
       
     }	
	 const openDeleteactividades = async (id,padre) =>{
   
		const elimino = await alerta(3)
		if(elimino){
		   fetch("{% url 'modalNewLesson'%}", {
			  ...fetchObject,
			  body: JSON.stringify({
				 method: "Delete",
				 id,
				 padre
			  })
		   })
		   .then(async (res) => {
			  const text = JSON.parse(await res.text())
			  if (text.message == "error")  makeMessage(4, "{% translate 'Notificacion' %}", "{% translate 'un error ha occurrido y no se pudo procesar su solicitud' %}", 'fa fa-exclamation-triangle')
  
			  else  makeMessage(1, "{% translate 'Notificacion' %}", "{% translate 'Archivo eliminado satisfactoriamente' %}", 'fas fa-trash-alt')
  
		   })
		   .then(()=>{
			renderContent(padre)
		   })
		}
	 } 
	 const opengopages = (id) =>{
		window.location.href = `{% url 'pageslessons' %}?id=${id}`
					 
	 }
	 new Sortable(document.querySelector("#resultado"), {
		handle: '.handle',
		animation: 150,
		chosenClass: "seleccionado",
		ghostClass: "fantasma",
		dragClass: "drag",
		onEnd: function (evt) {
		   let arreglo = []
		   evt.to.children.forEach(element => arreglo.push(element.dataset.move));
		   move({{id}}, arreglo)
		},
	 });
	 const move = (id, data) => {

		setLoading()
		fetch("{% url 'modalNewLesson'%}", {
		   ...fetchObject,
		   body: JSON.stringify({
			  id,
			  method:"sort",
			  data
		   })
		})
		
		.then(async (res) => {
		   const text = JSON.parse(await res.text())
		   if (text.message == "error") makeMessage(4, "{% translate 'Error' %}", "{% translate 'Ha ocurrido un error y no se pudo procesar su solicitud' %}", 'fa fa-exclamation-triangle')
		   else makeMessage(1, "{% translate 'Muy Bien!' %}", "{% translate 'Registro ordenado' %}", "fa fa-check")
		   renderContent({{id}}) 
		   stopLoading()
		})
	   
  
	 } 
</script>
{% endblock javascripts %}
